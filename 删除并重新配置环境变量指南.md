# 删除并重新配置环境变量指南 🔄

## ⚠️ 重要说明

根据QQ邮箱官方说明图片，我们使用以下配置：
- **发送邮件服务器**：smtp.qq.com
- **端口**：587（使用STARTTLS）或 465（使用SSL）
- **用户名**：你的QQ邮箱完整地址（2330304961@qq.com）
- **密码**：生成的授权码（bwzqgvsfgehwdjde）

**注意**：IMAP是用于接收邮件的协议，发送邮件仍然需要使用SMTP协议。我们继续使用SMTP，但改用587端口（STARTTLS）而不是465端口（SSL）。

## 📋 步骤1：删除旧的环境变量

### 方法1：使用Vercel CLI删除（推荐）

打开PowerShell，在项目目录下运行以下命令：

```powershell
cd C:\Users\23303\OneDrive\Desktop\liwu

# 删除SMTP相关环境变量（所有环境）
vercel env rm SMTP_HOST production
vercel env rm SMTP_HOST preview
vercel env rm SMTP_HOST development

vercel env rm SMTP_PORT production
vercel env rm SMTP_PORT preview
vercel env rm SMTP_PORT development

vercel env rm SMTP_USER production
vercel env rm SMTP_USER preview
vercel env rm SMTP_USER development

vercel env rm SMTP_PASS production
vercel env rm SMTP_PASS preview
vercel env rm SMTP_PASS development

vercel env rm RECIPIENT_EMAIL production
vercel env rm RECIPIENT_EMAIL preview
vercel env rm RECIPIENT_EMAIL development

# 注意：DIARY_PASSWORD 和 MONGODB_URI 等其他变量不需要删除
```

### 方法2：在Vercel网站上删除

1. 访问：**https://vercel.com/duliangkuans-projects/liwu/settings/environment-variables**
2. 找到以下变量，点击右侧的"..."菜单，选择"Delete"：
   - `SMTP_HOST`
   - `SMTP_PORT`
   - `SMTP_USER`
   - `SMTP_PASS`
   - `RECIPIENT_EMAIL`
3. **注意**：不要删除 `DIARY_PASSWORD` 和 `MONGODB_URI` 等其他变量

## 📝 步骤2：添加新的环境变量

### 方法1：使用Vercel CLI添加（推荐）

```powershell
# 设置新配置（使用587端口和STARTTLS）
$email = "2330304961@qq.com"
$passcode = "bwzqgvsfgehwdjde"

# 添加到所有环境
foreach ($env in @("production", "preview", "development")) {
    # SMTP_HOST
    echo "smtp.qq.com" | vercel env add SMTP_HOST $env
    
    # SMTP_PORT（改为587，使用STARTTLS）
    echo "587" | vercel env add SMTP_PORT $env
    
    # SMTP_USER
    echo $email | vercel env add SMTP_USER $env
    
    # SMTP_PASS（授权码）
    echo $passcode | vercel env add SMTP_PASS $env
    
    # RECIPIENT_EMAIL
    echo $email | vercel env add RECIPIENT_EMAIL $env
}
```

### 方法2：在Vercel网站上手动添加

访问：**https://vercel.com/duliangkuans-projects/liwu/settings/environment-variables**

依次添加以下变量，**每个变量都要添加到三个环境**（Production、Preview、Development）：

#### ① SMTP_HOST
- **Key**: `SMTP_HOST`
- **Value**: `smtp.qq.com`
- **Environments**: ☑️ Production  ☑️ Preview  ☑️ Development
- 点击 "Save"

#### ② SMTP_PORT（重要：改为587）
- **Key**: `SMTP_PORT`
- **Value**: `587` ⚠️ **注意：改为587端口（使用STARTTLS）**
- **Environments**: ☑️ Production  ☑️ Preview  ☑️ Development
- 点击 "Save"

#### ③ SMTP_USER
- **Key**: `SMTP_USER`
- **Value**: `2330304961@qq.com`
- **Environments**: ☑️ Production  ☑️ Preview  ☑️ Development
- 点击 "Save"

#### ④ SMTP_PASS（授权码）
- **Key**: `SMTP_PASS`
- **Value**: `bwzqgvsfgehwdjde`
- **Environments**: ☑️ Production  ☑️ Preview  ☑️ Development
- 点击 "Save"

#### ⑤ RECIPIENT_EMAIL
- **Key**: `RECIPIENT_EMAIL`
- **Value**: `2330304961@qq.com`
- **Environments**: ☑️ Production  ☑️ Preview  ☑️ Development
- 点击 "Save"

## ✅ 步骤3：验证配置

### 使用CLI验证

```powershell
vercel env ls
```

应该能看到：
- ✅ `SMTP_HOST` = `smtp.qq.com` (Production, Preview, Development)
- ✅ `SMTP_PORT` = `587` (Production, Preview, Development)
- ✅ `SMTP_USER` = `2330304961@qq.com` (Production, Preview, Development)
- ✅ `SMTP_PASS` = `***` (Production, Preview, Development)
- ✅ `RECIPIENT_EMAIL` = `2330304961@qq.com` (Production, Preview, Development)
- ✅ `DIARY_PASSWORD` = `***` (Production, Preview, Development)

### 在网站上验证

访问环境变量页面，确认所有变量都已正确添加。

## 🚀 步骤4：重新部署

配置完环境变量后，**必须重新部署**！

### 方法1：在Vercel网站上重新部署

1. 访问：**https://vercel.com/duliangkuans-projects/liwu**
2. 点击 "Redeploy" 按钮
3. 选择最新的部署或直接重新部署
4. 等待部署完成（约2-3分钟）

### 方法2：推送代码触发自动部署

```powershell
git commit --allow-empty -m "trigger redeploy with new SMTP config"
git push origin main
```

## 📊 主要变化

### 端口变化

- **旧配置**：`SMTP_PORT = 465`（使用SSL）
- **新配置**：`SMTP_PORT = 587`（使用STARTTLS）

### 为什么改用587端口？

1. **STARTTLS更灵活**：587端口使用STARTTLS，在连接后再升级为加密，更灵活
2. **更广泛的兼容性**：587端口是标准的邮件提交端口，兼容性更好
3. **更好的防火墙支持**：某些网络环境对587端口的支持更好

## 🔍 测试

部署完成后：

1. 访问网站
2. 点击右下角漂流瓶按钮 🫧
3. 输入测试内容（如："这是一封测试邮件，使用587端口"）
4. 点击"倾诉"按钮
5. 查看Vercel部署日志中的邮件发送日志
6. 检查邮箱 `2330304961@qq.com` 是否收到邮件

## 📝 环境变量清单

### 需要保留的变量（不要删除）

- ✅ `DIARY_PASSWORD` = `admin888888`
- ✅ `MONGODB_URI` = `...`（如果已配置）
- ✅ `DB_NAME` = `xiaokuixing_diary`（如果已配置）

### 需要重新添加的变量（已更新配置）

- ✅ `SMTP_HOST` = `smtp.qq.com`
- ✅ `SMTP_PORT` = `587` ⚠️ **改为587**
- ✅ `SMTP_USER` = `2330304961@qq.com`
- ✅ `SMTP_PASS` = `bwzqgvsfgehwdjde`
- ✅ `RECIPIENT_EMAIL` = `2330304961@qq.com`

## ⚠️ 注意事项

1. **不要删除DIARY_PASSWORD**：这是查看历史日记的密码，不是SMTP相关的
2. **不要删除MONGODB_URI**：这是数据库连接字符串，不是SMTP相关的
3. **确保所有环境都配置**：每个变量都要添加到Production、Preview、Development三个环境
4. **配置后必须重新部署**：环境变量只在新部署时生效

## 🐛 如果出现问题

1. **检查环境变量是否已删除**：`vercel env ls`
2. **检查新环境变量是否已添加**：`vercel env ls`
3. **查看部署日志**：访问Vercel项目页面，查看Function Logs
4. **测试邮件发送**：使用网站上的树洞功能测试

## 🎉 完成！

配置完成后，邮件发送功能将使用587端口（STARTTLS），这应该能更好地在Vercel serverless环境中工作。

