# 自定义域名配置说明 🌐

## 域名信息
- **域名**: `dufengyun.xyz`
- **注册商**: 阿里云
- **部署平台**: Vercel

## 一、Vercel域名配置步骤

### 1. 在Vercel中添加自定义域名

1. 登录 [Vercel控制台](https://vercel.com)
2. 进入你的项目（liwu）
3. 点击 **Settings** → **Domains**
4. 在 **Domains** 页面，点击 **Add** 按钮
5. 输入你的域名：`dufengyun.xyz`
6. 点击 **Add** 确认

### 2. 配置DNS解析（阿里云）

在阿里云DNS控制台添加以下DNS记录：

#### 方式一：使用CNAME记录（推荐）

| 记录类型 | 主机记录 | 记录值 | TTL |
|---------|---------|--------|-----|
| CNAME | @ | cname.vercel-dns.com | 600 |
| CNAME | www | cname.vercel-dns.com | 600 |

**说明**：
- `@` 表示根域名（dufengyun.xyz）
- `www` 表示 www.dufengyun.xyz
- 记录值请使用Vercel提供的实际CNAME值（在Vercel域名设置页面会显示）

#### 方式二：使用A记录

如果CNAME不适用，可以使用A记录：

| 记录类型 | 主机记录 | 记录值 | TTL |
|---------|---------|--------|-----|
| A | @ | 76.76.21.21 | 600 |
| A | www | 76.76.21.21 | 600 |

**注意**：A记录的IP地址可能会变化，建议使用CNAME方式。

### 3. 等待DNS生效

- DNS解析通常需要 **5分钟到48小时** 生效
- 可以使用以下命令检查DNS是否生效：
  ```bash
  # Windows PowerShell
  nslookup dufengyun.xyz
  
  # 或使用在线工具
  # https://dnschecker.org/
  ```

### 4. 验证SSL证书

- Vercel会自动为你的域名配置SSL证书（HTTPS）
- 证书配置通常需要几分钟到几小时
- 在Vercel的域名设置页面可以查看SSL证书状态

## 二、代码配置说明

### CORS配置

代码已更新，支持以下域名：

```javascript
// server.js 中的CORS配置
const allowedOrigins = [
    'https://dufengyun.xyz',
    'https://www.dufengyun.xyz',
    /^https:\/\/.*\.vercel\.app$/  // Vercel默认域名
];
```

### 前端API调用

前端代码使用相对路径，会自动适配当前域名：

```javascript
// 自动使用当前域名
fetch('/api/diaries', { ... })
fetch('/api/treehole/send', { ... })
```

## 三、验证配置

### 1. 检查域名解析

```bash
# 检查A记录
nslookup dufengyun.xyz

# 检查CNAME记录
nslookup -type=CNAME dufengyun.xyz
```

### 2. 测试网站访问

1. 访问 `https://dufengyun.xyz`
2. 确认网站正常加载
3. 测试所有功能：
   - ✅ 保存日记
   - ✅ 查看历史
   - ✅ 树洞倾诉（邮件发送）

### 3. 检查HTTPS

- 确认浏览器地址栏显示 🔒 锁图标
- 确认URL以 `https://` 开头

## 四、常见问题

### Q1: DNS解析不生效？

**解决方案**：
1. 检查DNS记录是否正确
2. 清除DNS缓存：
   ```bash
   # Windows
   ipconfig /flushdns
   ```
3. 等待更长时间（最长48小时）
4. 检查域名是否已正确添加到Vercel

### Q2: SSL证书配置失败？

**解决方案**：
1. 确认DNS解析已生效
2. 在Vercel域名设置中重新配置SSL
3. 检查域名是否被其他服务占用
4. 联系Vercel支持

### Q3: 网站可以访问但API调用失败？

**解决方案**：
1. 检查浏览器控制台的错误信息
2. 确认CORS配置正确
3. 检查Vercel函数日志
4. 确认环境变量已正确配置

### Q4: 邮件发送功能在自定义域名下不工作？

**解决方案**：
1. 邮件发送功能与域名无关，主要依赖SMTP配置
2. 检查Vercel环境变量中的SMTP配置
3. 查看Vercel函数日志中的错误信息
4. 参考 `修复说明.md` 中的DNS解析问题解决方案

## 五、DNS记录示例（阿里云）

### 在阿里云DNS控制台添加记录：

1. 登录 [阿里云控制台](https://dns.console.aliyun.com/)
2. 找到你的域名 `dufengyun.xyz`
3. 点击 **解析设置**
4. 添加以下记录：

**记录1：根域名**
- 记录类型：`CNAME`
- 主机记录：`@`
- 记录值：`cname.vercel-dns.com`（或Vercel提供的实际值）
- TTL：`600`

**记录2：www子域名**
- 记录类型：`CNAME`
- 主机记录：`www`
- 记录值：`cname.vercel-dns.com`（或Vercel提供的实际值）
- TTL：`600`

## 六、部署后检查清单

- [ ] DNS记录已正确配置
- [ ] DNS解析已生效（可通过nslookup验证）
- [ ] 域名已添加到Vercel项目
- [ ] SSL证书已自动配置
- [ ] 网站可以通过 `https://dufengyun.xyz` 访问
- [ ] 所有功能（日记、历史、树洞）正常工作
- [ ] 邮件发送功能正常
- [ ] 浏览器控制台无CORS错误

## 七、相关文档

- [Vercel域名配置官方文档](https://vercel.com/docs/concepts/projects/domains)
- [阿里云DNS解析文档](https://help.aliyun.com/product/29697.html)
- [环境变量配置说明](./环境变量配置说明.md)
- [修复说明](./修复说明.md)

---

**配置完成后，你的网站就可以通过 `https://dufengyun.xyz` 访问了！** 🎉

