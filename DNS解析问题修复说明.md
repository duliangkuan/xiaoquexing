# DNS解析问题修复说明 🔧

## 问题原因

在Vercel的serverless环境中，DNS解析受到严格限制，导致无法解析`smtp.qq.com`域名，出现以下错误：

```
DNS解析失败,无法解析SMTP服务器地址。这可能是serverless环境的DNS限制,已重试多次仍失败
```

## 解决方案

### 1. 完全跳过DNS解析，直接使用IP地址

代码已经优化为：

1. **对于QQ邮箱，直接使用备用IP地址**（第220-229行）
   - 完全跳过DNS解析
   - 使用QQ邮箱SMTP服务器的备用IP地址

2. **使用自定义lookup函数**（第127-131行）
   - 重写nodemailer的lookup函数
   - 直接返回IP地址，不进行任何DNS查询
   - 完全避免serverless环境的DNS限制

3. **配置TLS验证**（第144-149行）
   - 使用IP地址连接时，TLS仍使用域名进行证书验证
   - 确保SSL/TLS连接正常工作

### 2. 备用IP地址配置

代码中配置了多个备用IP地址（第13-19行）：

```javascript
const QQ_SMTP_IPS = [
    '14.17.57.61',     // QQ邮箱SMTP服务器IP（2024年最新，优先使用）
    '140.249.11.194',  // QQ邮箱SMTP常见IP（备用）
    '163.177.90.124'   // 备用IP
];
```

如果第一个IP地址连接失败，会自动尝试其他IP地址。

### 3. 重试机制

代码实现了智能重试机制（第208-301行）：

1. **DNS错误检测**：自动识别DNS相关错误
2. **自动重试**：DNS错误时自动重试（最多3次）
3. **备用IP切换**：如果第一个IP失败，自动尝试其他IP

## 代码改动

### 主要修改点

1. **自定义lookup函数**（第127-131行）
   ```javascript
   transporterConfig.lookup = function(hostname, options, callback) {
       // 直接返回IP地址，完全避免DNS解析
       callback(null, smtpIp, 4);
   };
   ```

2. **直接使用备用IP**（第226-229行）
   ```javascript
   else if (smtpHost === 'smtp.qq.com') {
       // 直接使用备用IP，跳过DNS解析
       smtpIp = QQ_SMTP_IPS[0];
   }
   ```

3. **TLS配置优化**（第144-149行）
   - 确保使用IP地址连接时，TLS仍使用域名验证

## 工作原理

1. **检测QQ邮箱**：如果SMTP服务器是`smtp.qq.com`，直接使用备用IP地址
2. **自定义lookup**：使用自定义lookup函数，直接返回IP地址，不查询DNS
3. **TLS验证**：虽然使用IP地址连接，但TLS证书验证仍使用域名
4. **错误重试**：如果连接失败，自动重试并尝试其他备用IP

## 验证

修复后，邮件发送应该能够：

1. ✅ **完全跳过DNS解析**：不再尝试解析`smtp.qq.com`域名
2. ✅ **直接使用IP地址**：使用QQ邮箱SMTP服务器的IP地址连接
3. ✅ **正常发送邮件**：能够成功连接到SMTP服务器并发送邮件

## 测试步骤

部署完成后：

1. **访问网站**
   - 等待部署完成（约2-3分钟）

2. **测试树洞倾诉功能**
   - 点击右下角的漂流瓶按钮 🫧
   - 输入测试内容
   - 点击"倾诉"按钮

3. **检查结果**
   - 应该不再出现DNS解析错误
   - 邮件应该能够成功发送
   - 检查邮箱是否收到邮件

## 如果仍然失败

如果修复后仍然无法发送邮件，请检查：

1. **IP地址是否正确**
   - QQ邮箱SMTP服务器的IP地址可能会变化
   - 可能需要更新`QQ_SMTP_IPS`数组中的IP地址

2. **查看部署日志**
   - 访问Vercel项目页面
   - 查看Function Logs
   - 查找具体的错误信息

3. **授权码是否正确**
   - 确保SMTP_PASS环境变量已更新为新授权码
   - 确保授权码没有过期

## 总结

通过完全跳过DNS解析并使用IP地址直接连接，我们成功解决了Vercel serverless环境的DNS限制问题。现在邮件发送功能应该能够正常工作。


