# 邮件发送诊断检查清单 ✅

## 📋 完整诊断流程

### 步骤1：检查环境变量配置

在Vercel项目中检查以下环境变量：

```bash
vercel env ls
```

**必需的环境变量：**
- ✅ `SMTP_HOST` = `smtp.qq.com`
- ✅ `SMTP_PORT` = `465`
- ✅ `SMTP_USER` = `2330304961@qq.com`
- ✅ `SMTP_PASS` = `bwzqgvsfgehwdjde`（新授权码）
- ✅ `RECIPIENT_EMAIL` = `2330304961@qq.com`

**确保：**
- 所有环境变量都添加到所有环境（Production、Preview、Development）
- 授权码是最新的（已更新为：`bwzqgvsfgehwdjde`）

### 步骤2：检查Vercel部署日志

1. 访问：**https://vercel.com/duliangkuans-projects/liwu**
2. 点击最新的部署
3. 查看 **Function Logs**
4. 查找以下日志标签：
   - `[发送邮件]` - 发送过程
   - `[Transporter配置]` - 连接配置
   - `[TLS配置]` - TLS配置
   - `[自定义lookup]` - DNS解析
   - `[错误详情]` - 错误信息

### 步骤3：测试邮件发送

1. **访问网站**
2. **点击右下角漂流瓶按钮** 🫧
3. **输入测试内容**（如："这是一封测试邮件"）
4. **点击"倾诉"按钮**
5. **查看：**
   - 浏览器控制台（F12）
   - Vercel部署日志

### 步骤4：分析日志输出

#### 成功的情况应该看到：

```
[发送邮件] 开始发送邮件到: 2330304961@qq.com
[发送邮件] 使用SMTP服务器: 140.249.11.194 (IP):465
[Transporter配置] 使用IP地址连接: 140.249.11.194，TLS主机名: smtp.qq.com
[TLS配置] 465端口，servername: smtp.qq.com，使用IP: 140.249.11.194
[自定义lookup] 跳过DNS解析，直接返回IP地址: 140.249.11.194 (原始hostname: smtp.qq.com)
[发送邮件] ✅ 邮件发送成功!
[发送邮件] MessageId: <xxx@qq.com>
[发送邮件] 收件人: 2330304961@qq.com
[发送邮件] 响应: 250 Mail OK
```

#### 失败的情况可能看到：

**错误1：环境变量未配置**
```
[错误详情] 错误代码: N/A
[错误详情] 错误消息: 邮件服务未配置，缺少环境变量: SMTP_USER, SMTP_PASS
```
**解决方案**：检查Vercel环境变量配置

**错误2：认证失败**
```
[错误详情] 错误代码: EAUTH
[错误详情] 错误消息: Invalid login
[错误详情] SMTP响应: 535 Error: authentication failed
```
**解决方案**：
- 检查`SMTP_USER`是否正确
- 检查`SMTP_PASS`（授权码）是否正确
- 确保授权码不是QQ登录密码
- 确保授权码没有过期

**错误3：连接失败**
```
[错误详情] 错误代码: ECONNECTION
[错误详情] 错误消息: Unable to connect to the server
```
**解决方案**：
- 检查网络连接
- 可能是IP地址不正确
- 尝试使用其他备用IP地址

**错误4：DNS解析失败**
```
[错误详情] 错误代码: ENOTFOUND
[错误详情] 错误消息: DNS解析失败
```
**解决方案**：
- 代码已自动使用备用IP地址，应该能解决
- 如果仍然失败，可能需要更新备用IP地址

## 🔧 已实施的修复

### 1. 增强日志输出 ✅
- 添加了详细的日志标签，便于识别
- 记录所有关键步骤和错误信息

### 2. 优化IP地址选择 ✅
- 根据重试次数自动切换不同的备用IP
- 提高了成功率

### 3. 改进DNS解析绕过 ✅
- 使用`setImmediate`确保异步执行
- 完全避免DNS解析

### 4. 优化TLS配置 ✅
- 添加`checkServerIdentity`跳过服务器身份检查
- 确保TLS握手使用域名

### 5. 调整备用IP顺序 ✅
- 将更可靠的IP地址放在前面

## 📝 常见问题

### Q1: 为什么还是无法发送邮件？

**A:** 请查看Vercel部署日志中的`[错误详情]`部分，根据错误代码和消息进行排查。

### Q2: 如何查看详细的日志？

**A:** 
1. 访问Vercel项目页面
2. 点击最新的部署
3. 查看Function Logs
4. 搜索`[发送邮件]`或`[错误详情]`

### Q3: 授权码是否正确？

**A:** 当前配置的授权码是：`bwzqgvsfgehwdjde`。如果邮件发送失败并显示认证错误，可能需要：
- 重新生成QQ邮箱授权码
- 更新`SMTP_PASS`环境变量

### Q4: IP地址是否正确？

**A:** 代码中配置了多个备用IP地址：
- `140.249.11.194`（优先使用）
- `163.177.90.124`（备用）
- `14.17.57.61`（备用）

如果所有IP都失败，可能需要查找最新的QQ邮箱SMTP服务器IP地址。

## ✅ 验证清单

- [ ] 所有环境变量已正确配置
- [ ] 环境变量已添加到所有环境（Production、Preview、Development）
- [ ] 授权码是最新的（`bwzqgvsfgehwdjde`）
- [ ] 代码已部署到Vercel
- [ ] 已查看Vercel部署日志
- [ ] 已测试邮件发送功能
- [ ] 已检查邮箱是否收到邮件

## 🎯 下一步

1. **等待部署完成**（约2-3分钟）
2. **查看Vercel部署日志**
3. **测试邮件发送功能**
4. **根据日志中的错误信息进行排查**

## 📞 获取帮助

如果问题仍然存在，请提供：
1. Vercel部署日志中的`[错误详情]`部分
2. 错误代码和错误消息
3. SMTP响应（如果有）

这将有助于进一步诊断问题。


